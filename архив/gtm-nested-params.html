<!-- 
    –í–ï–†–°–ò–Ø –° –í–õ–û–ñ–ï–ù–ù–´–ú–ò –ü–ê–†–ê–ú–ï–¢–†–ê–ú–ò –í–ò–ó–ò–¢–û–í –î–õ–Ø GTM
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É OverpoweredJS –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö –≤–∏–∑–∏—Ç–æ–≤
    
    –ó–ê–ú–ï–ù–ò–¢–ï:
    - 45047126 –Ω–∞ –≤–∞—à ID —Å—á–µ—Ç—á–∏–∫–∞ –Ø–Ω–¥–µ–∫—Å –ú–µ—Ç—Ä–∏–∫–∏
    - public_CtOgbP-edO5NnL6A3rbKtlX0Xzxvx-CVeyW –Ω–∞ –≤–∞—à API –∫–ª—é—á OverpoweredJS
-->

<!-- OverpoweredJS CDN -->
<script src="https://cdn.overpoweredjs.com/loader/opjs"></script>

<!-- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤–∏–∑–∏—Ç–æ–≤ -->
<script>
(function() {
    // –ù–ê–°–¢–†–û–ô–ö–ò - –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–®–ò –ó–ù–ê–ß–ï–ù–ò–Ø
    var METRIKA_ID = '45047126';  // –í–ê–® ID –°–ß–ï–¢–ß–ò–ö–ê –Ø–ù–î–ï–ö–° –ú–ï–¢–†–ò–ö–ò
    var API_KEY = 'public_CtOgbP-edO5NnL6A3rbKtlX0Xzxvx-CVeyW';  // –í–ê–® API –ö–õ–Æ–ß OVERPOWEREDJS
    var DEBUG = true;  // true –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏, false –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
    
    var sessionKey = 'overpowered_metrika_sent_' + METRIKA_ID;
    var clickHandled = false;
    
    function isAlreadySent() {
        try {
            return sessionStorage.getItem(sessionKey) === 'true';
        } catch (e) {
            return false;
        }
    }
    
    function markAsSent() {
        try {
            sessionStorage.setItem(sessionKey, 'true');
        } catch (e) {
            if (DEBUG) console.warn('[OverpoweredMetrika] SessionStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        }
    }
    
    function addParam(obj, key, value) {
        if (value !== null && value !== undefined) {
            obj[key] = value;
        }
    }
    
    function sendOverpoweredDataToMetrika() {
        if (isAlreadySent()) {
            if (DEBUG) console.log('[OverpoweredMetrika] –î–∞–Ω–Ω—ã–µ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —ç—Ç–æ–º –≤–∏–∑–∏—Ç–µ');
            return;
        }
        
        if (typeof window.opjs === 'undefined' || typeof window.ym === 'undefined') {
            console.error('[OverpoweredMetrika] OverpoweredJS –∏–ª–∏ –Ø–Ω–¥–µ–∫—Å –ú–µ—Ç—Ä–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            return;
        }
        
        if (DEBUG) console.log('[OverpoweredMetrika] –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö...');
        
        window.opjs({ API_KEY: API_KEY }).then(function(data) {
            if (DEBUG) console.log('[OverpoweredMetrika] –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ OverpoweredJS:', data);
            
            // 1. –ü–ê–†–ê–ú–ï–¢–†–´ –ü–û–°–ï–¢–ò–¢–ï–õ–ï–ô (–ø–ª–æ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)
            var userParams = {};
            
            addParam(userParams, 'overpowered_bot_score', data.botScore);
            addParam(userParams, 'overpowered_cluster_uuid', data.clusterUUID);
            addParam(userParams, 'overpowered_last_seen', data.lastSeen);
            addParam(userParams, 'overpowered_risk_level', data.botScore > 7 ? 'high' : data.botScore > 4 ? 'medium' : 'low');
            addParam(userParams, 'overpowered_timestamp', new Date().toISOString());
            
            if (data.browserTraits) {
                addParam(userParams, 'browser_type', data.browserTraits.type);
                addParam(userParams, 'browser_has_canvas_noise', data.browserTraits.hasCanvasNoise);
                addParam(userParams, 'browser_is_incognito', data.browserTraits.isIncognito);
                addParam(userParams, 'browser_is_webview', data.browserTraits.isWebView);
                addParam(userParams, 'browser_is_android_webview', data.browserTraits.isAndroidWebView);
                addParam(userParams, 'browser_fake_user_agent', data.browserTraits.isFakeUserAgent);
                addParam(userParams, 'browser_rooted_device', data.browserTraits.isRootedDevice);
                addParam(userParams, 'browser_anti_detect', data.browserTraits.isAntiDetect);
                
                if (data.browserTraits.possibleCountryCodes && data.browserTraits.possibleCountryCodes.length > 0) {
                    addParam(userParams, 'browser_country_codes', data.browserTraits.possibleCountryCodes.join(','));
                }
            }
            
            if (data.debug) {
                addParam(userParams, 'overpowered_performance', data.debug.performance);
            }
            
            // 2. –ü–ê–†–ê–ú–ï–¢–†–´ –í–ò–ó–ò–¢–û–í (–≤–ª–æ–∂–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ OverpoweredJS)
            var visitParams = {
                clusterUUID: data.clusterUUID,
                botScore: data.botScore,
                lastSeen: data.lastSeen,
                analysisTimestamp: new Date().toISOString()
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º browserTraits –∫–∞–∫ –≤–ª–æ–∂–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç
            if (data.browserTraits) {
                var browserTraits = {};
                
                addParam(browserTraits, 'type', data.browserTraits.type);
                addParam(browserTraits, 'hasCanvasNoise', data.browserTraits.hasCanvasNoise);
                addParam(browserTraits, 'isIncognito', data.browserTraits.isIncognito);
                addParam(browserTraits, 'isWebView', data.browserTraits.isWebView);
                addParam(browserTraits, 'isAndroidWebView', data.browserTraits.isAndroidWebView);
                addParam(browserTraits, 'isFakeUserAgent', data.browserTraits.isFakeUserAgent);
                addParam(browserTraits, 'isRootedDevice', data.browserTraits.isRootedDevice);
                addParam(browserTraits, 'isAntiDetect', data.browserTraits.isAntiDetect);
                
                if (data.browserTraits.possibleCountryCodes && data.browserTraits.possibleCountryCodes.length > 0) {
                    addParam(browserTraits, 'possibleCountryCodes', data.browserTraits.possibleCountryCodes);
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
                if (Object.keys(browserTraits).length > 0) {
                    visitParams.browserTraits = browserTraits;
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            if (data.debug && data.debug.performance) {
                visitParams.debug = {
                    performance: data.debug.performance
                };
            }
            
            if (DEBUG) {
                console.log('[OverpoweredMetrika] –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π (–ø–ª–æ—Å–∫–∏–µ):', userParams);
                console.log('[OverpoweredMetrika] –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∏–∑–∏—Ç–∞ (–≤–ª–æ–∂–µ–Ω–Ω—ã–µ):', visitParams);
                console.log('[OverpoweredMetrika] –ü–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π:', Object.keys(userParams).length);
            }
            
            // –û–¢–ü–†–ê–í–õ–Ø–ï–ú –î–ê–ù–ù–´–ï
            window.ym(METRIKA_ID, 'userParams', userParams);
            window.ym(METRIKA_ID, 'params', visitParams);
            
            markAsSent();
            
            if (DEBUG) {
                console.log('[OverpoweredMetrika] ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã');
                console.log('[OverpoweredMetrika] üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∏–∑–∏—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —Å –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å—é');
            }
            
            // –¶–ï–õ–¨ –¢–û–õ–¨–ö–û –î–õ–Ø –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û–ô –ê–ö–¢–ò–í–ù–û–°–¢–ò (–±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)
            if (data.botScore > 5) {
                window.ym(METRIKA_ID, 'reachGoal', 'suspicious_activity', {
                    bot_score: data.botScore,
                    risk_level: data.botScore > 7 ? 'high' : 'medium'
                });
                
                if (DEBUG) console.log('[OverpoweredMetrika] üö® –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ü–µ–ª—å "suspicious_activity"');
            }
            
        }).catch(function(error) {
            console.error('[OverpoweredMetrika] ‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:', error);
        });
    }
    
    function handleFirstClick() {
        if (clickHandled) return;
        clickHandled = true;
        
        if (DEBUG) console.log('[OverpoweredMetrika] üëÜ –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫ - –∑–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é');
        sendOverpoweredDataToMetrika();
    }
    
    function addClickListener() {
        document.addEventListener('click', handleFirstClick);
        if (DEBUG) console.log('[OverpoweredMetrika] üìù –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω');
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            if (DEBUG) console.log('[OverpoweredMetrika] üöÄ DOM –∑–∞–≥—Ä—É–∂–µ–Ω');
            addClickListener();
        });
    } else {
        if (DEBUG) console.log('[OverpoweredMetrika] üöÄ DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        addClickListener();
    }
    
    // –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    if (DEBUG) {
        window.OverpoweredMetrikaForceRun = function() {
            console.log('[OverpoweredMetrika] üîß –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫...');
            clickHandled = false;
            sendOverpoweredDataToMetrika();
        };
        
        window.OverpoweredMetrikaClearSession = function() {
            try {
                sessionStorage.removeItem(sessionKey);
                console.log('[OverpoweredMetrika] üóëÔ∏è –°–µ—Å—Å–∏—è –æ—á–∏—â–µ–Ω–∞');
            } catch (e) {
                console.warn('[OverpoweredMetrika] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é');
            }
        };
        
        console.log('[OverpoweredMetrika] üõ†Ô∏è –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã:');
        console.log('- OverpoweredMetrikaForceRun() - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫');
        console.log('- OverpoweredMetrikaClearSession() - –æ—á–∏—Å—Ç–∫–∞ —Å–µ—Å—Å–∏–∏');
    }
    
})();
</script>
